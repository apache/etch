<?xml version="1.0" encoding="utf-8" ?>
<project name="build.common" basedir=".">

    <!-- Static properties -->
    <property name="Etch.copyrightNotice"    value="Copyright (c) 2007 Cisco Systems, Inc. All rights reserved." />

    <!-- Load Environment -->
    <property environment="env" />
    <property prefix="Etch.property."      file="./etch.properties" />
    <property prefix="Etch.runtime."       file="./bamboo.properties" />

    <!-- Validate properties -->
    <condition property="Etch.property.majorVersion" value="0">
        <not><isset property="Etch.property.majorVersion" /></not>
    </condition>
    <condition property="Etch.property.minorVersion" value="0" >
        <not><isset property="Etch.property.minorVersion" /></not>
    </condition>
    <condition property="Etch.property.patchVersion" value="0" >
        <not><isset property="Etch.property.patchVersion" /></not>
    </condition>

    <condition property="Etch.runtime.workspace" value="${basedir}" >
        <not><isset property="Etch.runtime.workspace" /></not>
    </condition>

    <condition property="Etch.runtime.buildKey" value="LOCAL" >
        <not><isset property="Etch.runtime.buildKey" /></not>
    </condition>
    <condition property="Etch.runtime.buildNumber" value="0" >
        <not><isset property="Etch.runtime.buildNumber" /></not>
    </condition>
    <condition property="Etch.runtime.revisionNumber" value="0" >
        <not><isset property="Etch.runtime.revisionNumber" /></not>
    </condition>

	<condition property="Etch.runtime.buildPath" value="build" >
	    <not><isset property="Etch.runtime.buildPath" /></not>
	</condition>

    <property name="Etch.version" value="${Etch.property.majorVersion}.${Etch.property.minorVersion}.${Etch.property.patchVersion}" />
    <property name="Etch.buildTag" value="${Etch.runtime.buildKey}-${Etch.runtime.buildNumber}" />

	<property name="Etch.buildDirectory" value="${Etch.runtime.workspace}/${Etch.runtime.buildPath}" />
	<property name="Etch.buildSupportDirectory" value="${Etch.runtime.workspace}/build-support" />
    <property name="Etch.logDirectory"       value="${Etch.buildDirectory}/BuildLogs" />
    <property name="Etch.installerDirectory" value="${Etch.buildDirectory}/Installers" />
    <property name="Etch.dist"               value="${Etch.installerDirectory}/dist" />

    <!-- Define filterset for build-time substitutions -->
    <filterset id="Etch.buildTokens" >
        <filter token="EtchVersion"               value="${Etch.version}" />
        <filter token="EtchBuildTag"              value="${Etch.buildTag}" />
        <filter token="EtchRuntimeRevisionNumber" value="${Etch.runtime.revisionNumber}" />
        <filter token="EtchRuntimeBuildKey"       value="${Etch.runtime.buildKey}" />
        <filter token="EtchRuntimeBuildNumber"    value="${Etch.runtime.buildNumber}" />
        <filter token="EtchMajorVersion"          value="${Etch.property.majorVersion}" />
        <filter token="EtchMinorVersion"          value="${Etch.property.minorVersion}" />
        <filter token="EtchPatchVersion"          value="${Etch.property.patchVersion}" />
    </filterset>

    <!-- TODO: Migrate to .NET tasks for ANT -->
    <property name="tool.vs-2k5-task" value="${Etch.runtime.workspace}/scripts/vs-2k5-task.bat" />

    <!-- NSIS installer support -->
    <property name="tool.makensis"    value="C:\Program Files\NSIS\makensis.exe" />

    <tempfile property="Etch.build.tmpdir" destdir="/tmp" />

    <property   name="Etch.dependency.javacc.home"
                value="${Etch.runtime.workspace}/3rdparty/javacc-4.0" />
    <property   name="Etch.dependency.junit.jar"
                value="${Etch.runtime.workspace}/3rdparty/junit4.1/junit-4.1.jar" />
    <property   name="Etch.dependency.velocity.jar"
                value="${Etch.runtime.workspace}/3rdparty/velocity-1.5/velocity-1.5.jar" />
    <property   name="Etch.dependency.velocity-dep.jar"
                value="${Etch.runtime.workspace}/3rdparty/velocity-1.5/velocity-dep-1.5.jar" />

    <path id="Etch.dependencies.jar.paths">
        <!-- <pathelement location="${Etch.dependency.velocity.jar}" /> -->
        <pathelement location="${Etch.dependency.velocity-dep.jar}" />
        <pathelement location="${Etch.dependency.junit.jar}" />
    </path>

    <!-- macros -->
    <macrodef name="build_component" >
        <attribute name="root" default="." />
        <attribute name="dir"  default="build-support" />
        <attribute name="target" default="${Etch.build.target}" />
        <attribute name="script" default="build" />
        <attribute name="antfile" default="@{script}.xml" />
        <attribute name="loglabel" default="@{script}" />
        <attribute name="output" default="${Etch.logDirectory}/@{loglabel}.@{target}.txt" />
        <element   name="componentAntElements" optional="true" implicit="true" />
        <sequential>
            <echo message="@{loglabel}.@{target}" />
            <ant dir="@{root}" antfile="@{dir}/@{antfile}" inheritAll="false" inheritRefs="false" output="@{output}" target="@{target}">
                <componentAntElements />
            </ant>
        </sequential>
    </macrodef>

    <!-- NSIS macro -->
    <macrodef name="makensis">
        <attribute name="root"        default="." />
        <attribute name="dir"         default="." />
        <attribute name="target"      default="${Etch.build.target}" />
        <attribute name="script"      default="myscript" />
        <attribute name="loglabel"    default="@{script}" />
        <attribute name="output"      default="${Etch.logsDirectory}/@{loglabel}.@{target}.txt" />
        <attribute name="failonerror" default="false" />
        <sequential>
            <exec executable="${tool.makensis}" dir="@{root}/@{dir}" failonerror="@{failonerror}" >
                <arg value="@{script}.nsi" />
            </exec>
        </sequential>
    </macrodef>

    <!-- etch macro -->
    <macrodef name="etch">
        <attribute name="home"              default="${Etch.dist}" />
        <attribute name="jar"               default="@{home}/bin/etch.jar" />
        <attribute name="dir"               default="." />
        <attribute name="outputdir"         default="." />
        <attribute name="file"              default="interface.etch" />
        <attribute name="wordlist"          default="" />
        <attribute name="ignoreglobal"      default="false" />
        <attribute name="ignorelocal"       default="false" />
        <attribute name="who"               default="both" />
        <attribute name="binding"           default="java" />
        <attribute name="failonerror"       default="true" />
        <sequential>
            <!-- TODO: add logic to support 'wordlist', 'ignoreglobal', 'ignorelocal', and 'outputDir' -->
            <java jar="@{jar}" fork="true" dir="@{dir}" failonerror="@{failonerror}" >
                <arg value="--binding" /><arg value="@{binding}" />
                <arg value="--who" /><arg value="@{who}" />
                <arg value="@{file}" />
            </java>
        </sequential>
    </macrodef>

    <!-- Migrate to .NET Tasks for ANT -->
    <macrodef name="visualstudio-task">
        <attribute name="root" default="." />
        <attribute name="dir"  default="." />
        <attribute name="solution" default="@{dir}" />
        <attribute name="target"   default="${Etch.build.target}" />
        <attribute name="project"  default="" />
        <attribute name="loglabel" default="@{solution}" />
        <attribute name="logdir"   default="@{dir}" />
        <attribute name="output"   default="@{logdir}/@{loglabel}.@{target}.txt" />
        <attribute name="failonerror"    default="false" />
        <sequential>
            <!-- <echo message="Tool: ${tool.vs-2k5-task}" /> -->
            <!-- <echo message="Dir:  @{root}/@{dir}" /> -->
            <echo message="VS-2K5-TASK: @{solution} @{target} @{project}" />
            <!-- <exec executable="${tool.vs-2k5-task}" dir="@{root}/@{dir}" output="@{output}" failonerror="@{failonerror}"> -->
            <exec executable="${tool.vs-2k5-task}" dir="@{root}/@{dir}" failonerror="@{failonerror}">
                <arg value="@{solution}.sln" />
                <arg value="@{target}" />
                <arg value="@{project}" />
            </exec>
        </sequential>
    </macrodef>

    <!-- TODO: generate output XML for Bamboo -->
    <macrodef name="run-junit">
        <attribute name="classname"     default="class.name" />
        <attribute name="classdir"      default="." />
        <attribute name="classpath-ref" default="Etch.dependencies.jar.paths" />
        <sequential>
            <java fork="true" classname="junit.textui.TestRunner" taskname="junit" failonerror="false">
                <arg value="@{classname}" />
                <classpath>
                    <pathelement location="@{classesdir}" />
                </classpath>
                <classpath refid="@{classpath-ref}" />
            </java>
        </sequential>
    </macrodef>
</project>
